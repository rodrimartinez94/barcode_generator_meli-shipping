<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Código de Barras - MELI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url('https://www.woosync.io/wp-content/uploads/2022/02/3-Trucos-para-vender-mas-por-Internet-e-incrementar-ventas.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      padding: 30px 40px;
      width: 450px;
      max-width: 90%;
      text-align: center;
      position: relative;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .meli-logo {
      height: 40px;
    }

    .switch-wrapper {
      display: flex;
      align-items: center;
      font-size: 0.9em;
      gap: 8px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
      border-radius: 34px;
      background-color: #f5f5f5;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 24px;
      width: 24px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    input:checked + .slider {
      background-color: #ffdd00;
    }

    input:checked + .slider:before {
      transform: translateX(30px);
    }

    .lang-label {
      font-weight: bold;
    }

    h2 {
      font-size: 1.4em;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .underline {
      height: 4px;
      width: 60px;
      background-color: #ffdd00;
      margin: 0 auto 20px auto;
      border-radius: 2px;
    }

    label {
      display: block;
      font-size: 1em;
      margin-bottom: 10px;
      text-align: left;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin-bottom: 20px;
      box-sizing: border-box;
    }

    button {
      border: none;
      padding: 12px 20px;
      font-size: 1em;
      border-radius: 12px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      transition: background 0.3s ease;
      margin-top: 10px;
    }

    #submitBtn {
      background-color: #ffdd00;
    }

    #submitBtn:hover {
      background-color: #fddc00cc;
    }

    #printBtn {
      background-color: #ffdd00;
    }

    #backBtn {
      background-color: #ddd;
    }

    /* Botón para abrir bluetooth-internals */
    #openBluetoothBtn {
      background-color: #0073e6;
      color: #fff;
    }

    /* Botones de la pantalla inicial */
    #configBtn {
      background-color: #0073e6;
      color: #fff;
    }

    #startBarcodeBtn {
      background-color: #ffdd00;
    }

    .btn-icon {
      height: 18px;
      width: 18px;
      object-fit: contain;
      vertical-align: -3px;
      margin-right: 8px;
    }

    /* Modal integrado para instrucciones de Bluetooth Internals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
      z-index: 1000;
    }

    .modal {
      background: #fff;
      width: 600px;
      max-width: 95vw;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
      overflow: hidden;
    }

    .modal-header {
      padding: 14px 18px;
      background: #ffdd00;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: bold;
    }

    .modal-body {
      padding: 18px;
      text-align: left;
    }

    .close-btn {
      background: transparent;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      width: auto;
      margin-top: 0;
    }

    .link-box {
      background: #f7f7f7;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      word-break: break-all;
      margin: 12px 0 6px 0;
    }

    .link-box a {
      color: #0073e6;
      text-decoration: none;
      font-weight: bold;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    /* Botón abrir nueva pestaña en el modal */
    #openNewTabBtn {
      background-color: #ffdd00;
    }

    .manual-paste {
      width: 100%;
      min-height: 80px;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      box-sizing: border-box;
      margin-top: 10px;
      font-family: inherit;
    }

    /* Caja de información (amarillo suave) */
    .info-box {
      background: #fff4b8;
      border: 1px solid #f0e1a0;
      color: #333;
      padding: 12px 14px;
      border-radius: 10px;
      box-sizing: border-box;
      text-align: left;
      line-height: 1.5;
    }

    .info-box ul {
      margin: 8px 0 0 18px;
      padding: 0;
      list-style-type: disc;
    }

    .info-box li {
      margin-bottom: 6px;
    }

    .browser-version {
      font-size: 0.9em;
      color: #555;
      margin: 12px 0 0 0;
      background: #f5f5f7;
      border: 1px solid #e5e5e8;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    #versionActions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    #updateChromeBtn {
      background-color: #ffdd00;
    }

    #resultContainer {
      display: none;
    }

    #result img {
      max-width: 100%;
    }

    @media print {
      #printBtn, #backBtn, #openBluetoothBtn, #bluetoothModal, #configImageModal, .switch-wrapper, .header, .underline, #title {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <img id="meliLogo" src="https://logodownload.org/wp-content/uploads/2018/10/mercado-libre-logo.png" alt="MercadoLibre Logo" class="meli-logo">
      </div>
      <div class="switch-wrapper">
        <span class="lang-label">ES</span>
        <label class="switch">
          <input type="checkbox" id="langToggle">
          <span class="slider"></span>
        </label>
        <span class="lang-label">PT</span>
      </div>
    </div>

    <h2 id="homeTitle"></h2>
    <div class="underline"></div>

    <!-- Pantalla inicial (Landing) -->
    <div id="landingContainer">
      <button type="button" id="configBtn">⚙️ Configuración inicial</button>
      <button type="button" id="startBarcodeBtn"><i class="fas fa-barcode"></i> Generar Barcode Bluetooth</button>
      <div id="browserVersion" class="browser-version">
        <span id="browserVersionLabel"></span>
        <div id="versionActions" style="display:none;">
          <button type="button" id="updateChromeBtn">Actualizar Chrome</button>
        </div>
      </div>
    </div>

    <!-- Título para flujo de código de barras -->
    <h2 id="title" style="display:none;"></h2>

    <div id="formContainer" style="display:none;">
      <form id="barcodeForm">
        <label for="mac" id="macLabel">
          Ingresar MAC Bluetooth<br>
          <span style="font-size: 0.9em; color: #555;">(desde navegador ChromeOS: chrome://bluetooth-internals)</span>
        </label>
        <button type="button" id="openBluetoothBtn" onclick="onOpenBluetoothClick()">Extraer MAC Bluetooth</button>
        <input type="text" id="mac" name="mac" placeholder="Ej: AABBCC112233" required>
        <button type="submit" id="submitBtn">Generar Código</button>
        <button type="button" id="backToHomeFromFormBtn" style="background:#ddd;">Volver</button>
      </form>
    </div>

    <div id="resultContainer">
      <div id="result"></div>
      <button id="printBtn" onclick="window.print()">Imprimir</button>
      <button id="backBtn" onclick="goBack()">Volver</button>
    </div>

    <!-- Modal integrado para abrir bluetooth-internals -->
    <div id="bluetoothModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <span id="bluetoothTitle">Obtener MAC Bluetooth de ChromeOS</span>
          <button class="close-btn" aria-label="Cerrar" onclick="closeBluetoothModal()">✕</button>
        </div>
        <div class="modal-body">
          <p id="bluetoothInstructions">Para obtener la dirección MAC Bluetooth, copia y abre el enlace en una nueva pestaña. En la sección Adapter, copia el valor que aparece en Address y regresa a la seccion "Generar Código" para continuar el proceso.</p>
          <div class="link-box">
            <a id="bluetoothLink" href="#" rel="noopener noreferrer">chrome://bluetooth-internals</a>
            <button type="button" id="copyLinkBtn" class="close-btn" style="font-size:0.95em;" onclick="copyBluetoothLink()">Copiar enlace</button>
          </div>
          <div id="copyFeedback" style="font-size:0.9em; color:#2e7d32; display:none;">Enlace copiado</div>
          <div class="modal-actions">
            <button type="button" id="openNewTabBtn" onclick="openNewTab()">Abrir una nueva pestaña</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Pantalla de Configuración Inicial -->
    <div id="configContainer" style="display:none;">
      <div id="configIntro" class="info-box">
        Para configurar correctamente el Ring Scanner, deberá escanear los siguientes códigos de barras en el orden indicado, a fin de completar la configuración de manera adecuada.<br><br>
        <strong>Puntos a tener en cuenta:</strong><br>
        - Si el firmware del Ring es <strong>MELI</strong>, deberá escanear los códigos del <strong>1 al 4</strong> en orden.<br>
        - Si el firmware del Ring es <strong>GLOBAL</strong>, deberá escanear únicamente el <strong>código 4</strong>.
      </div>
      <button type="button" id="openImageBtn" style="background:#ffdd00;">Ver Códigos de Configuración</button>
      <button type="button" id="backToHomeBtn" style="background:#ddd;">Volver</button>
    </div>

    <!-- Modal para ver imagen en tamaño completo -->
    <div id="configImageModal" class="modal-overlay" style="display:none;">
      <div class="modal" style="max-width:95vw; width:auto;">
        <div class="modal-header">
          <span id="configImageTitle">Códigos de configuración</span>
          <button id="closeImageX" class="close-btn" aria-label="Cerrar" onclick="closeConfigImageModal()">✕</button>
        </div>
        <div class="modal-body" style="text-align:center;">
          <img id="configImageFull" src="ConfigBarCodeMeli.png" alt="Códigos de configuración" style="max-width:95vw; max-height:80vh; border-radius:10px;">
          <div class="modal-actions" style="justify-content:center;">
            <button type="button" id="closeImageBtn" style="background:#ddd; width:auto; min-width:140px;" onclick="closeConfigImageModal()">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const translations = {
      es: {
        homeTitle: "<span style='color:#0073e6; font-weight:bold;'>SHIPPING MELI</span><br>Proceso de Ring Scanner RS5100",
        title: "<span style='color:#0073e6; font-weight:bold;'>SHIPPING MELI</span><br>Generador de Código de Barras",
        macLabel: "Ingresar MAC Bluetooth<br><span style='font-size: 0.9em; color: #555;'>(Obtenido desde navegador ChromeOS: chrome://bluetooth-internals)</span>",
        placeholder: "Ej: AABBCC112233",
        submitBtn: "Generar Código",
        openBluetooth: "Extraer MAC Bluetooth",
        configInit: "Configuración inicial",
        startBarcode: "Generar Barcode Bluetooth",
        configImageAlt: "Configuración inicial RS5100",
        bluetoothInstructions: "Para obtener la dirección MAC Bluetooth, copia y abre el enlace en una nueva pestaña. En la sección Adapter, copia el valor que aparece en Address y regresa a la sección \"Generar Código\" para continuar el proceso.",
        bluetoothTitle: "Obtener MAC Bluetooth de ChromeOS",
        copyLink: "Copiar enlace",
        openNewTab: "Abrir una nueva pestaña",
        openImage: "Ver Códigos de Configuración",
        imageTitle: "Códigos de configuración",
        close: "Cerrar",
        configIntro: "Para configurar correctamente el Ring Scanner, deberá escanear los siguientes códigos de barras en el orden indicado, a fin de completar la configuración de manera adecuada.<br><br><strong>Puntos a tener en cuenta:</strong><ul><li>Si el firmware del Ring es <strong>MELI</strong>, deberá escanear los códigos del <strong>1 al 4</strong> en orden.</li><li>Si el firmware del Ring es <strong>GLOBAL</strong>, deberá escanear únicamente el <strong>código 4</strong>.</li></ul>",
        openWindow: "Abrir en nueva ventana",
        pasteClipboard: "Pegar MAC del portapapeles",
        manualPastePlaceholder: "Pega aquí el contenido copiado de la sección Adapter...",
        alert: "Por favor ingresa una MAC válida",
        logo: "https://logodownload.org/wp-content/uploads/2018/10/mercado-libre-logo.png",
        print: "Imprimir Código",
        back: "Volver",
        updateChrome: "Actualizar Chrome"
      },
      pt: {
        homeTitle: "<span style='color:#0073e6; font-weight:bold;'>SHIPPING MELI</span><br>Processo do Ring Scanner RS5100",
        title: "<span style='color:#0073e6; font-weight:bold;'>SHIPPING MELI</span><br>Gerador de Código de Barras",
        macLabel: "Inserir MAC Bluetooth<br><span style='font-size: 0.9em; color: #555;'>(Obtido no navegador ChromeOS: chrome://bluetooth-internals)</span>",
        placeholder: "Ex: AABBCC112233",
        submitBtn: "Gerar Código",
        openBluetooth: "Extrair MAC Bluetooth",
        configInit: "Configuração inicial",
        startBarcode: "Gerar Barcode Bluetooth",
        configImageAlt: "Configuração inicial RS5100",
        bluetoothInstructions: "Para obter o endereço MAC Bluetooth, copie e abra o link em uma nova aba. Na seção Adapter, copie o valor de Address e volte para a seção \"Gerar Código\" para continuar.",
        bluetoothTitle: "Obter MAC Bluetooth do ChromeOS",
        copyLink: "Copiar link",
        openNewTab: "Abrir uma nova aba",
        openImage: "Ver Códigos de Configuração",
        imageTitle: "Códigos de configuração",
        close: "Fechar",
        configIntro: "Para configurar corretamente o Ring Scanner, você deve escanear os seguintes códigos de barras na ordem indicada, a fim de concluir a configuração adequadamente.<br><br><strong>Pontos a considerar:</strong><ul><li>Se o firmware do Ring for <strong>MELI</strong>, escaneie os códigos de <strong>1 a 4</strong> em ordem.</li><li>Se o firmware do Ring for <strong>GLOBAL</strong>, escaneie apenas o <strong>código 4</strong>.</li></ul>",
        openWindow: "Abrir em nova janela",
        pasteClipboard: "Colar MAC da área de transferência",
        manualPastePlaceholder: "Cole aqui o conteúdo copiado da seção Adapter...",
        alert: "Por favor, insira um MAC válido",
        logo: "https://upload.wikimedia.org/wikipedia/pt/0/04/Logotipo_MercadoLivre.png",
        print: "Imprimir Código",
        back: "Voltar",
        updateChrome: "Atualizar o Chrome"
      }
    };

    let currentLang = 'es';

    // Iconos solicitados (Flaticon)
    const ICON_BARCODE = 'https://cdn-icons-png.flaticon.com/512/39/39881.png';
    const ICON_SETTINGS = 'https://cdn-icons-png.flaticon.com/512/2040/2040504.png';

    function setTextIfExists(id, text) {
      const el = document.getElementById(id);
      if (el) el.innerText = text;
    }

    function setHTMLIfExists(id, html) {
      const el = document.getElementById(id);
      if (el) el.innerHTML = html;
    }

    function setPlaceholderIfExists(id, text) {
      const el = document.getElementById(id);
      if (el) el.placeholder = text;
    }

    function setSrcIfExists(id, src) {
      const el = document.getElementById(id);
      if (el) el.src = src;
    }

    function setAltIfExists(id, alt) {
      const el = document.getElementById(id);
      if (el) el.alt = alt;
    }

    function setLanguage(lang) {
      currentLang = lang;
      setHTMLIfExists('homeTitle', translations[lang].homeTitle);
      setHTMLIfExists('title', translations[lang].title);
      setHTMLIfExists('macLabel', translations[lang].macLabel);
      setHTMLIfExists('bluetoothInstructions', translations[lang].bluetoothInstructions);
      setTextIfExists('bluetoothTitle', translations[lang].bluetoothTitle);
      setTextIfExists('copyLinkBtn', translations[lang].copyLink);
      setTextIfExists('openNewTabBtn', translations[lang].openNewTab);
      setHTMLIfExists('configIntro', translations[lang].configIntro);
      setTextIfExists('openImageBtn', translations[lang].openImage);
      setTextIfExists('configImageTitle', translations[lang].imageTitle);
      setTextIfExists('closeImageBtn', translations[lang].close);
      const bv = document.getElementById('browserVersionLabel');
      if (bv) bv.innerText = getBrowserVersionLabel(lang);
      setTextIfExists('updateChromeBtn', translations[lang].updateChrome);
      setPlaceholderIfExists('mac', translations[lang].placeholder);
      setTextIfExists('submitBtn', translations[lang].submitBtn);
      setTextIfExists('openBluetoothBtn', translations[lang].openBluetooth);
      setHTMLIfExists('configBtn', `<img class="btn-icon" src="${ICON_SETTINGS}" alt=""> ${translations[lang].configInit}`);
      setHTMLIfExists('startBarcodeBtn', `<img class="btn-icon" src="${ICON_BARCODE}" alt=""> ${translations[lang].startBarcode}`);
      // elementos opcionales removidos del modal; ignorar si no existen
      setTextIfExists('openBluetoothWindowBtn', translations[lang].openWindow);
      setTextIfExists('pasteFromClipboardBtn', translations[lang].pasteClipboard);
      setPlaceholderIfExists('manualPasteArea', translations[lang].manualPastePlaceholder);
      setTextIfExists('printBtn', translations[lang].print);
      setTextIfExists('backBtn', translations[lang].back);
      setTextIfExists('backToHomeBtn', translations[lang].back);
      setSrcIfExists('meliLogo', translations[lang].logo);
    }

    document.getElementById('langToggle').addEventListener('change', function () {
      setLanguage(this.checked ? 'pt' : 'es');
    });

    function detectChromeVersion() {
      try {
        const ua = navigator.userAgent || '';
        // En algunos builds, la versión completa viene en "Chrome/140.0.0.0" y el build real en Edg/ o Safari/WebKit no aplica.
        // Intentar extraer version completa de "Version/" (Android), o de WebView fallback
        let m = ua.match(/(?:Chrome|CriOS)\/(\d+\.\d+\.\d+\.\d+)/);
        if (m) return m[1];
        m = ua.match(/(?:Chrome|CriOS)\/(\d+\.\d+\.\d+)/);
        if (m) return m[1];
        // Probar patrón con "Version/xx.xx.xx.xx" (p.e. WebView Android)
        m = ua.match(/Version\/(\d+\.\d+\.\d+\.\d+)/);
        if (m) return m[1];
        // Fallback a UA-CH (suele dar solo major)
        const uaData = navigator.userAgentData;
        if (uaData && Array.isArray(uaData.brands)) {
          const brand = uaData.brands.find(b => /Chrom(e|ium)/i.test(b.brand));
          if (brand && brand.version) return brand.version;
        }
        return '';
      } catch (e) { return ''; }
    }

    function getBrowserVersionLabel(lang) {
      const version = detectChromeVersion();
      if (!version) return lang === 'pt' ? 'Versão do Chrome: desconhecida' : 'Versión de Chrome: desconocida';
      // Si las subversiones están ocultas (ej. 140.0.0.0), mostrar solo la principal
      let display = version;
      try {
        const m = version.match(/^(\d+)(?:\.(\d+))?(?:\.(\d+))?(?:\.(\d+))?$/);
        if (m) {
          const major = m[1];
          const s2 = m[2] || '0';
          const s3 = m[3] || '0';
          const s4 = m[4] || '0';
          if (s2 === '0' && s3 === '0' && s4 === '0') display = major;
        }
      } catch (e) {}
      return lang === 'pt' ? `Versão do Chrome: ${display}` : `Versión de Chrome: ${display}`;
    }

    setLanguage(currentLang);
    // Inicializa rótulo de versión en landing
    const bv = document.getElementById('browserVersionLabel');
    if (bv) bv.innerText = getBrowserVersionLabel(currentLang);
    // Mostrar botón de actualizar si versión < 140
    try {
      const version = detectChromeVersion();
      const major = parseInt((version.match(/^(\d+)/) || [,'0'])[1], 10);
      const actions = document.getElementById('versionActions');
      if (actions) actions.style.display = (!isNaN(major) && major < 140) ? 'flex' : 'none';
    } catch (e) {}

    // Navegación entre pantallas
    function showHome() {
      const home = document.getElementById('landingContainer');
      const form = document.getElementById('formContainer');
      const result = document.getElementById('resultContainer');
      const config = document.getElementById('configContainer');
      const homeTitle = document.getElementById('homeTitle');
      const barcodeTitle = document.getElementById('title');
      if (home) home.style.display = 'block';
      if (form) form.style.display = 'none';
      if (result) result.style.display = 'none';
      if (config) config.style.display = 'none';
      if (homeTitle) homeTitle.style.display = 'block';
      if (barcodeTitle) barcodeTitle.style.display = 'none';
    }

    function showConfig() {
      const home = document.getElementById('landingContainer');
      const config = document.getElementById('configContainer');
      const homeTitle = document.getElementById('homeTitle');
      const barcodeTitle = document.getElementById('title');
      if (home) home.style.display = 'none';
      if (config) config.style.display = 'block';
      if (homeTitle) homeTitle.style.display = 'block';
      if (barcodeTitle) barcodeTitle.style.display = 'none';
    }

    function showBarcodeForm() {
      const home = document.getElementById('landingContainer');
      const form = document.getElementById('formContainer');
      const result = document.getElementById('resultContainer');
      const config = document.getElementById('configContainer');
      const homeTitle = document.getElementById('homeTitle');
      const barcodeTitle = document.getElementById('title');
      if (home) home.style.display = 'none';
      if (config) config.style.display = 'none';
      if (result) result.style.display = 'none';
      if (form) form.style.display = 'block';
      if (homeTitle) homeTitle.style.display = 'none';
      if (barcodeTitle) barcodeTitle.style.display = 'block';
    }

    // Botones de navegación
    const configBtn = document.getElementById('configBtn');
    if (configBtn) configBtn.addEventListener('click', showConfig);
    const startBarcodeBtn = document.getElementById('startBarcodeBtn');
    if (startBarcodeBtn) startBarcodeBtn.addEventListener('click', showBarcodeForm);
    const backToHomeBtn = document.getElementById('backToHomeBtn');
    if (backToHomeBtn) backToHomeBtn.addEventListener('click', showHome);
    const openImageBtn = document.getElementById('openImageBtn');
    if (openImageBtn) openImageBtn.addEventListener('click', function(){
      const modal = document.getElementById('configImageModal');
      if (modal) modal.style.display = 'flex';
    });

    function closeConfigImageModal() {
      const modal = document.getElementById('configImageModal');
      if (modal) modal.style.display = 'none';
    }
    const updateChromeBtn = document.getElementById('updateChromeBtn');
    if (updateChromeBtn) updateChromeBtn.addEventListener('click', function(){
      // Abrimos un popup auxiliar con instrucciones y botón para navegar
      const url = 'chrome://os-settings';
      let win = null;
      try { win = window.open('', 'osSettingsPopup', 'popup=yes,width=900,height=680'); } catch (e) { win = null; }
      if (!win) {
        alert(currentLang === 'pt' ? 'Habilite pop-ups e tente novamente.' : 'Habilita ventanas emergentes y vuelve a intentar.');
        return;
      }
      const title = (currentLang === 'pt') ? 'Configurações do ChromeOS' : 'Configuración de ChromeOS';
      const openLabel = (currentLang === 'pt') ? 'Abrir agora' : 'Abrir ahora';
      const copyLabel = (currentLang === 'pt') ? 'Copiar link' : 'Copiar enlace';
      const hint = (currentLang === 'pt')
        ? 'Clique em Abrir agora. Se não funcionar, copie o link e cole na barra de endereços e pressione Enter.'
        : 'Haz clic en Abrir ahora. Si no funciona, copia el enlace y pégalo en la barra de direcciones y presiona Enter.';
      const html = `<!DOCTYPE html><html lang="${currentLang}"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial,sans-serif;margin:0;padding:20px}h2{margin:0 0 10px 0}.row{margin:14px 0}button{border:none;padding:10px 14px;font-size:1em;border-radius:10px;cursor:pointer;background:#ffdd00;font-weight:bold;margin-right:8px}code{background:#f7f7f7;border:1px solid #e0e0e0;border-radius:8px;padding:6px 8px;display:inline-block}</style></head><body><h2>${title}</h2><div class="row">${hint}</div><div class="row"><button id="go">${openLabel}</button><button id="copy">${copyLabel}</button></div><div class="row"><code>${url}</code></div><script>document.getElementById('go').addEventListener('click',function(){try{location.href='${url}';}catch(e){}});document.getElementById('copy').addEventListener('click',async function(){try{await navigator.clipboard.writeText('${url}');}catch(e){}});<\/script></body></html>`;
      try { win.document.open(); win.document.write(html); win.document.close(); } catch (e) {}
    });
    const backToHomeFromFormBtn = document.getElementById('backToHomeFromFormBtn');
    if (backToHomeFromFormBtn) backToHomeFromFormBtn.addEventListener('click', function(){ try{ document.getElementById('barcodeForm').reset(); }catch(e){} showHome(); });

    // Pantalla inicial
    showHome();

    // Apertura de bluetooth-internals con modal integrado
    const BLUETOOTH_INTERNALS_URL = 'chrome://bluetooth-internals';

    function showBluetoothModal() {
      const modal = document.getElementById('bluetoothModal');
      const link = document.getElementById('bluetoothLink');
      modal.style.display = 'flex';
      link.textContent = BLUETOOTH_INTERNALS_URL;
      link.setAttribute('href', BLUETOOTH_INTERNALS_URL);
      document.getElementById('copyFeedback').style.display = 'none';
    }

    function closeBluetoothModal() {
      const modal = document.getElementById('bluetoothModal');
      modal.style.display = 'none';
    }

    function copyBluetoothLink() {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(BLUETOOTH_INTERNALS_URL)
          .then(() => {
            const fb = document.getElementById('copyFeedback');
            fb.style.display = 'block';
            setTimeout(() => { fb.style.display = 'none'; }, 1500);
          })
          .catch(() => {});
      }
    }

    function openNewTab() {
      try {
        window.open('about:blank', '_blank');
      } catch (e) {}
    }

    // Acción principal del botón (asegura compatibilidad si addEventListener falla)
    function onOpenBluetoothClick() {
      showBluetoothModal();
    }

    // Limpieza de código: se eliminaron funciones no utilizadas

    document.getElementById('openBluetoothBtn').addEventListener('click', onOpenBluetoothClick);

    document.getElementById("barcodeForm").addEventListener("submit", function(event) {
      event.preventDefault();
      const macRaw = document.getElementById("mac").value.trim();
      if (!macRaw) {
        alert(translations[currentLang].alert);
        return;
      }

      // Limpia separadores y deja 12 hex
      const macClean = macRaw.replace(/[^0-9A-Fa-f]/g, '').toUpperCase();
      if (!macClean || macClean.length !== 12) {
        alert(translations[currentLang].alert);
        return;
      }

      const prefix = "\\<FNC3>PH11A";
      const dataToEncode = prefix + macClean;
      const encodedData = encodeURIComponent(dataToEncode);

      const barcodeURL = "https://barcode.tec-it.com/barcode.ashx?data=" + encodedData + "&code=Code128&translate-esc=on";

      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = `
        <img src="${barcodeURL}" alt="Código de Barras">
      `;

      document.getElementById("formContainer").style.display = "none";
      document.getElementById("resultContainer").style.display = "block";
    });

    function goBack() {
      document.getElementById("formContainer").style.display = "block";
      document.getElementById("resultContainer").style.display = "none";
      document.getElementById("barcodeForm").reset();
    }
  </script>
</body>
</html>
